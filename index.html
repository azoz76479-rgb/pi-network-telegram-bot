<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Mining - تعدين</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .language-switcher {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .language-switcher button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid #fdbb2d;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .language-switcher button:hover {
            background: rgba(253, 187, 45, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .btn:hover {
            background: #ffcc44;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .network-btn {
            background: #1a2a6c;
            color: white;
        }
        
        .mining-btn {
            font-size: 1.2rem;
            padding: 15px 40px;
            margin: 20px auto;
            display: block;
        }
        
        .confirm-btn {
            background: #28a745;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #34ce57;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fdbb2d;
            margin-top: 10px;
        }
        
        .swap-input {
            margin: 15px 0;
        }
        
        .swap-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .swap-input input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #fdbb2d;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
        }
        
        .swap-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .swap-details {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .warning {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        .success {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }
        
        .info-note {
            text-align: center;
            font-style: italic;
            opacity: 0.9;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .wallet-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        body[dir="ltr"] {
            text-align: left;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .swap-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button onclick="changeLanguage('ar')">العربية</button>
            <button onclick="changeLanguage('en')">English</button>
        </div>
        
        <header>
            <h1 id="title">Trust Mining</h1>
            <p class="subtitle" id="subtitle">Mining Made Simple</p>
        </header>

        <!-- قسم الشبكة -->
        <section class="section network-section">
            <h2 id="networkTitle">Network</h2>
            <button id="switchNetwork" class="btn network-btn">Switch to BEP20</button>
            <p id="networkStatus" class="warning">Not connected to BEP20</p>
        </section>
        
        <section class="section wallet-section">
            <h2 id="walletStatus">Connect Your Wallet</h2>
            <button id="connectWallet" class="btn">Connect Wallet</button>
            <div id="walletInfo" class="wallet-details" style="display: none;"></div>
        </section>
        
        <section class="section mining-section">
            <h2 id="miningTitle">Mining</h2>
            <div class="stats">
                <div class="stat-card">
                    <span id="miningBalanceLabel">Mining Balance</span>
                    <div class="stat-value" id="miningBalance">0.00</div>
                </div>
                <div class="stat-card">
                    <span id="totalEarnedLabel">Total Earned</span>
                    <div class="stat-value" id="totalEarned">0.00</div>
                </div>
            </div>
            
            <button id="startMining" class="btn mining-btn" disabled>Start Mining</button>
            <p id="miningStatus" class="warning" style="display: none;">You must transfer first to start mining</p>
        </section>
        
        <section class="section swap-section">
            <h3 id="swapTitle">Start Mining</h3>
            
            <div class="swap-input">
                <label id="swapAmountLabel">Amount (Minimum 20)</label>
                <input type="number" id="swapAmount" placeholder="20" step="1" min="20">
            </div>
            
            <div class="swap-actions">
                <button id="setSwapAmount" class="btn">Set Amount</button>
                <button id="confirmSwap" class="btn confirm-btn" disabled>Confirm & Start</button>
            </div>
            
            <div class="swap-details" id="swapDetails">
                <p id="swapSummary">Transfer: <span id="swapValue">0</span></p>
                <p id="swapFee">Daily Rate: <span id="feeValue">5%</span></p>
                <p id="swapNet">Daily Profit: <span id="netValue">0</span></p>
                <p class="warning" id="swapWarning">Click confirm to start mining</p>
            </div>
            
            <p class="warning" id="networkWarning">Use BEP20 Network Only</p>
        </section>
        
        <section class="section info-section">
            <p class="info-note" id="feeNote">
                Daily mining rate 5% - Minimum 20 - Direct to wallet
            </p>
        </section>
    </div>

    <script>
        const translations = {
            ar: {
                title: "Trust Mining",
                subtitle: "تعدين سهل",
                networkTitle: "الشبكة",
                switchNetwork: "التغيير إلى BEP20",
                networkConnected: "متصل بشبكة BEP20",
                networkNotConnected: "غير متصل بشبكة BEP20",
                connectWallet: "اتصال المحفظة",
                walletConnected: "متصل",
                walletNotConnected: "غير متصل",
                miningTitle: "التعدين",
                startMining: "بدء التعدين",
                stopMining: "إيقاف",
                miningBalance: "الرصيد",
                totalEarned: "الإجمالي",
                swapTitle: "بدء التعدين",
                swapAmountLabel: "المبلغ (20 حد أدنى)",
                setSwapAmount: "تعيين",
                confirmSwap: "تأكيد البدء",
                swapSummary: "تحويل:",
                swapFee: "النسبة اليومية:",
                swapNet: "ربح يومي:",
                swapWarning: "اضغط تأكيد لبدء التعدين",
                networkWarning: "شبكة BEP20 فقط",
                feeNote: "نسبة يومية 5% - حد أدنى 20 - مباشر للمحفظة",
                address: "العنوان",
                balance: "الرصيد",
                minAmountError: "الحد الأدنى 20",
                balanceError: "تجاوز الرصيد",
                transferRequired: "يجب التحويل أولاً لبدء التعدين",
                switchNetworkError: "الرجاء التغيير يدوياً إلى شبكة BEP20"
            },
            en: {
                title: "Trust Mining",
                subtitle: "Mining Made Simple",
                networkTitle: "Network",
                switchNetwork: "Switch to BEP20",
                networkConnected: "Connected to BEP20",
                networkNotConnected: "Not connected to BEP20",
                connectWallet: "Connect Wallet",
                walletConnected: "Connected",
                walletNotConnected: "Not Connected",
                miningTitle: "Mining",
                startMining: "Start Mining",
                stopMining: "Stop",
                miningBalance: "Balance",
                totalEarned: "Total",
                swapTitle: "Start Mining",
                swapAmountLabel: "Amount (Min 20)",
                setSwapAmount: "Set Amount",
                confirmSwap: "Confirm & Start",
                swapSummary: "Transfer:",
                swapFee: "Daily Rate:",
                swapNet: "Daily Profit:",
                swapWarning: "Click confirm to start mining",
                networkWarning: "BEP20 Network Only",
                feeNote: "Daily rate 5% - Min 20 - Direct to wallet",
                address: "Address",
                balance: "Balance",
                minAmountError: "Minimum 20",
                balanceError: "Exceeds balance",
                transferRequired: "You must transfer first to start mining",
                switchNetworkError: "Please manually switch to BEP20 network"
            }
        };

        let currentLanguage = 'en';
        let miningState = {
            isMining: false,
            isConnected: false,
            hasTransferred: false,
            balance: 0,
            totalEarned: 0,
            miningInterval: null,
            userAddress: null,
            userBalance: 0,
            isBEP20: false
        };

        let swapState = {
            amount: 0
        };

        const miningAddress = "0xfc712c9985507a2eb44df1ddfe7f09ff7613a19b";

        const connectWalletBtn = document.getElementById('connectWallet');
        const walletStatus = document.getElementById('walletStatus');
        const walletInfo = document.getElementById('walletInfo');
        const startMiningBtn = document.getElementById('startMining');
        const miningBalanceEl = document.getElementById('miningBalance');
        const totalEarnedEl = document.getElementById('totalEarned');
        const swapAmountInput = document.getElementById('swapAmount');
        const setSwapAmountBtn = document.getElementById('setSwapAmount');
        const confirmSwapBtn = document.getElementById('confirmSwap');
        const swapDetails = document.getElementById('swapDetails');
        const swapValueEl = document.getElementById('swapValue');
        const feeValueEl = document.getElementById('feeValue');
        const netValueEl = document.getElementById('netValue');
        const switchNetworkBtn = document.getElementById('switchNetwork');
        const networkStatus = document.getElementById('networkStatus');
        const miningStatus = document.getElementById('miningStatus');

        // ✅ دالة محسنة للتحقق من المتصفح
        function isWeb3Available() {
            return typeof window.ethereum !== 'undefined' || 
                   typeof window.trustwallet !== 'undefined' ||
                   typeof window.web3 !== 'undefined';
        }

        // ✅ دالة محسنة للحصول على provider
        function getWeb3Provider() {
            if (window.ethereum) {
                return window.ethereum;
            } else if (window.trustwallet) {
                return window.trustwallet;
            } else if (window.web3 && window.web3.currentProvider) {
                return window.web3.currentProvider;
            }
            return null;
        }

        // ✅ التحقق من الشبكة بشكل محسن
        async function checkNetwork() {
            const provider = getWeb3Provider();
            if (!provider) return false;

            try {
                const chainId = await provider.request({ method: 'eth_chainId' });
                
                // BEP20 Chain IDs المدعومة
                const supportedChains = [
                    '0x38',    // BSC Mainnet
                    '0x61',    // BSC Testnet
                    '0x1',     // Ethereum (backup)
                    '0xaa36a7' // Sepolia (test)
                ];
                
                miningState.isBEP20 = supportedChains.includes(chainId);
                updateNetworkStatus();
                return miningState.isBEP20;
            } catch (error) {
                console.error('Error checking network:', error);
                return checkNetworkFallback();
            }
        }

        // ✅ Fallback للشبكة
        async function checkNetworkFallback() {
            try {
                if (window.ethereum && window.ethereum.networkVersion) {
                    const networkId = window.ethereum.networkVersion;
                    miningState.isBEP20 = (networkId === '56' || networkId === '97');
                }
                updateNetworkStatus();
                return miningState.isBEP20;
            } catch (error) {
                return false;
            }
        }

        // ✅ تحديث حالة الشبكة
        function updateNetworkStatus() {
            const t = translations[currentLanguage];
            if (miningState.isBEP20) {
                networkStatus.textContent = t.networkConnected;
                networkStatus.className = 'success';
            } else {
                networkStatus.textContent = t.networkNotConnected;
                networkStatus.className = 'warning';
            }
        }

        // ✅ تغيير الشبكة إلى BEP20 بشكل محسن
        async function switchToBEP20() {
            const provider = getWeb3Provider();
            if (!provider) {
                alert(translations[currentLanguage].switchNetworkError);
                return;
            }

            try {
                await provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
                
                setTimeout(() => {
                    checkNetwork();
                }, 2000);
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await provider.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x38',
                                chainName: 'Binance Smart Chain',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                blockExplorerUrls: ['https://bscscan.com/']
                            }]
                        });
                    } catch (addError) {
                        console.error('Error adding network:', addError);
                    }
                }
                console.error('Error switching network:', switchError);
            }
        }

        // ✅ اتصال محفظة محسن
        async function connectWallet() {
            if (!isWeb3Available()) {
                alert(currentLanguage === 'ar' ? 
                    'لم يتم العثور على محفظة ويب٣. يرجى استخدام Trust Wallet أو MetaMask' : 
                    'Web3 wallet not found. Please use Trust Wallet or MetaMask');
                return;
            }

            const provider = getWeb3Provider();
            try {
                const accounts = await provider.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts && accounts.length > 0) {
                    miningState.isConnected = true;
                    miningState.userAddress = accounts[0];
                    
                    await getUserBalance(accounts[0]);
                    await checkNetwork();
                    
                    updateWalletDisplay();
                    
                } else {
                    throw new Error('No accounts found');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                
                if (error.code === 4001) {
                    alert(currentLanguage === 'ar' ? 
                        'تم رفض الاتصال من قبل المستخدم' : 
                        'Connection rejected by user');
                } else if (error.code === -32002) {
                    alert(currentLanguage === 'ar' ? 
                        'طلب اتصال معلق بالفعل. يرجى التحقق من المحفظة' : 
                        'Connection request already pending. Please check your wallet');
                } else {
                    alert(currentLanguage === 'ar' ? 
                        'خطأ في الاتصال: ' + error.message : 
                        'Connection error: ' + error.message);
                }
            }
        }

        // ✅ دالة محسنة للحصول على الرصيد
        async function getUserBalance(address) {
            const provider = getWeb3Provider();
            if (!provider) return 0;

            try {
                const balance = await provider.request({
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                });
                
                miningState.userBalance = parseInt(balance) / 1e18;
                updateWalletInfo();
                return miningState.userBalance;
            } catch (error) {
                console.error('Error getting balance:', error);
                try {
                    if (window.web3) {
                        const balance = await new Promise((resolve) => {
                            window.web3.eth.getBalance(address, (err, result) => {
                                if (err) resolve('0');
                                else resolve(result);
                            });
                        });
                        miningState.userBalance = parseInt(balance) / 1e18;
                        updateWalletInfo();
                        return miningState.userBalance;
                    }
                } catch (fallbackError) {
                    console.error('Fallback balance error:', fallbackError);
                }
                return 0;
            }
        }

        // ✅ تحديث العرض
        function updateWalletDisplay() {
            const t = translations[currentLanguage];
            walletStatus.textContent = t.walletConnected;
            startMiningBtn.disabled = false;
            walletInfo.style.display = 'block';
            updateWalletInfo();
        }

        function updateWalletInfo() {
            const t = translations[currentLanguage];
            if (miningState.isConnected && miningState.userAddress) {
                walletInfo.innerHTML = `
                    <p><strong>${t.address}:</strong> ${miningState.userAddress.slice(0, 6)}...${miningState.userAddress.slice(-4)}</p>
                    <p><strong>${t.balance}:</strong> ${miningState.userBalance.toFixed(4)} BNB</p>
                `;
            }
        }

        // ✅ إعداد event listeners
        function setupEventListeners() {
            const provider = getWeb3Provider();
            if (!provider) return;

            if (provider.on) {
                provider.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        miningState.isConnected = false;
                        walletStatus.textContent = translations[currentLanguage].walletNotConnected;
                        walletInfo.style.display = 'none';
                        startMiningBtn.disabled = true;
                        miningState.userAddress = null;
                    } else {
                        miningState.userAddress = accounts[0];
                        getUserBalance(accounts[0]);
                    }
                });
                
                provider.on('chainChanged', (chainId) => {
                    console.log('Chain changed to:', chainId);
                    checkNetwork();
                    if (miningState.userAddress) {
                        getUserBalance(miningState.userAddress);
                    }
                });
                
                provider.on('connect', (connectInfo) => {
                    console.log('Connected to chain:', connectInfo.chainId);
                });
                
                provider.on('disconnect', (error) => {
                    console.log('Disconnected:', error);
                    miningState.isConnected = false;
                    updateWalletDisplay();
                });
            }
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            updateTexts();
        }

        function updateTexts() {
            const t = translations[currentLanguage];
            
            document.getElementById('title').textContent = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('networkTitle').textContent = t.networkTitle;
            document.getElementById('switchNetwork').textContent = t.switchNetwork;
            document.getElementById('connectWallet').textContent = t.connectWallet;
            document.getElementById('walletStatus').textContent = miningState.isConnected ? 
                t.walletConnected : t.walletNotConnected;
            document.getElementById('miningTitle').textContent = t.miningTitle;
            document.getElementById('miningBalanceLabel').textContent = t.miningBalance;
            document.getElementById('totalEarnedLabel').textContent = t.totalEarned;
            document.getElementById('swapTitle').textContent = t.swapTitle;
            document.getElementById('swapAmountLabel').textContent = t.swapAmountLabel;
            document.getElementById('setSwapAmount').textContent = t.setSwapAmount;
            document.getElementById('confirmSwap').textContent = t.confirmSwap;
            document.getElementById('swapSummary').innerHTML = `${t.swapSummary} <span id="swapValue">0</span>`;
            document.getElementById('swapFee').innerHTML = `${t.swapFee} <span id="feeValue">5%</span>`;
            document.getElementById('swapNet').innerHTML = `${t.swapNet} <span id="netValue">0</span>`;
            document.getElementById('swapWarning').textContent = t.swapWarning;
            document.getElementById('networkWarning').textContent = t.networkWarning;
            document.getElementById('feeNote').textContent = t.feeNote;
            
            document.getElementById('startMining').textContent = 
                miningState.isMining ? t.stopMining : t.startMining;

            updateNetworkStatus();
        }

        // ✅ ربط الأحداث
        switchNetworkBtn.onclick = switchToBEP20;
        connectWalletBtn.onclick = connectWallet;

        startMiningBtn.onclick = function() {
            const t = translations[currentLanguage];
            
            if (!miningState.hasTransferred) {
                miningStatus.textContent = t.transferRequired;
                miningStatus.style.display = 'block';
                return;
            }

            if (!miningState.isMining) {
                miningState.isMining = true;
                miningState.startTime = Date.now();
                startMiningBtn.textContent = t.stopMining;
                miningStatus.style.display = 'none';
                
                miningState.miningInterval = setInterval(() => {
                    miningState.balance += 0.01;
                    miningBalanceEl.textContent = miningState.balance.toFixed(2);
                }, 1000);
                
            } else {
                miningState.isMining = false;
                miningState.totalEarned += miningState.balance;
                miningState.balance = 0;
                
                clearInterval(miningState.miningInterval);
                startMiningBtn.textContent = t.startMining;
                
                miningBalanceEl.textContent = '0.00';
                totalEarnedEl.textContent = miningState.totalEarned.toFixed(2);
            }
        };

        setSwapAmountBtn.onclick = function() {
            const amount = parseFloat(swapAmountInput.value);
            const t = translations[currentLanguage];
            
            if (amount >= 20 && amount <= miningState.userBalance) {
                swapState.amount = amount;
                const dailyRate = 0.05;
                const dailyProfit = amount * dailyRate;
                
                swapValueEl.textContent = amount;
                feeValueEl.textContent = "5%";
                netValueEl.textContent = dailyProfit.toFixed(2);
                
                swapDetails.style.display = 'block';
                confirmSwapBtn.disabled = false;
                
            } else {
                alert(amount < 20 ? t.minAmountError : t.balanceError);
            }
        };

        confirmSwapBtn.onclick = async function() {
            if (!swapState.amount || !miningState.userAddress) return;
            
            const provider = getWeb3Provider();
            if (!provider) return;

            const isBEP20 = await checkNetwork();
            if (!isBEP20) {
                alert(currentLanguage === 'ar' ? 
                    'الرجاء التغيير إلى شبكة BEP20 أولاً' : 
                    'Please switch to BEP20 network first');
                return;
            }
            
            try {
                const t = translations[currentLanguage];
                const balanceBefore = miningState.userBalance;
                
                const transactionHash = await provider.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: miningState.userAddress,
                        to: miningAddress,
                        value: '0x' + Math.floor(swapState.amount * 1e18).toString(16),
                        gas: "0x" + (30000).toString(16),
                        gasPrice: "0x" + (20e9).toString(16)
                    }]
                });
                
                alert(currentLanguage === 'ar' ? 
                    'تم إرسال العملية بنجاح! جاري التحقق...' : 
                    'Transaction sent successfully! Verifying...');
                
                setTimeout(async () => {
                    await getUserBalance(miningState.userAddress);
                    
                    if (miningState.userBalance < balanceBefore) {
                        miningState.hasTransferred = true;
                        
                        if (!miningState.isMining) {
                            startMiningBtn.click();
                        }
                        
                        alert(currentLanguage === 'ar' ? 
                            'تم التحويل بنجاح! بدء التعدين...' : 
                            'Transfer successful! Starting mining...');
                    }
                    
                }, 5000);
                
            } catch (error) {
                console.error('Transaction error:', error);
                if (error.code === 4001) {
                    alert(currentLanguage === 'ar' ? 
                        'تم إلغاء العملية من قبل المستخدم' : 
                        'Transaction cancelled by user');
                } else {
                    alert(currentLanguage === 'ar' ? 
                        'خطأ في العملية: ' + (error.message || error.toString()) : 
                        'Transaction error: ' + (error.message || error.toString()));
                }
            }
        };

        // ✅ التهيئة
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkNetwork();
            updateTexts();
            
            if (isWeb3Available() && getWeb3Provider().selectedAddress) {
                setTimeout(() => {
                    connectWallet();
                }, 1000);
            }
        });
    </script>
</body>
</html>
